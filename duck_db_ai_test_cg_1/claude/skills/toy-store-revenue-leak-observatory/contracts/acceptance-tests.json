{
  "schema_version": "1.0",
  "stage_tests": [
    {
      "stage_id": 1,
      "tests": [
        {
          "test_id": "SRC-001",
          "type": "exact_row_count",
          "model": "src__website_sessions",
          "expected_value": 472871
        },
        {
          "test_id": "SRC-002",
          "type": "exact_row_count",
          "model": "src__website_pageviews",
          "expected_value": 1188124
        },
        {
          "test_id": "SRC-003",
          "type": "exact_row_count",
          "model": "src__orders",
          "expected_value": 32313
        },
        {
          "test_id": "SRC-004",
          "type": "exact_row_count",
          "model": "src__order_items",
          "expected_value": 40025
        },
        {
          "test_id": "SRC-005",
          "type": "exact_row_count",
          "model": "src__order_item_refunds",
          "expected_value": 1731
        },
        {
          "test_id": "SRC-006",
          "type": "exact_row_count",
          "model": "src__products",
          "expected_value": 4
        },
        {
          "test_id": "SRC-007",
          "type": "pk_unique",
          "model": "src__website_sessions",
          "columns": [
            "website_session_id"
          ]
        },
        {
          "test_id": "SRC-008",
          "type": "pk_unique",
          "model": "src__website_pageviews",
          "columns": [
            "website_pageview_id"
          ]
        },
        {
          "test_id": "SRC-009",
          "type": "pk_unique",
          "model": "src__orders",
          "columns": [
            "order_id"
          ]
        },
        {
          "test_id": "SRC-010",
          "type": "pk_unique",
          "model": "src__order_items",
          "columns": [
            "order_item_id"
          ]
        },
        {
          "test_id": "SRC-011",
          "type": "pk_unique",
          "model": "src__order_item_refunds",
          "columns": [
            "order_item_refund_id"
          ]
        },
        {
          "test_id": "SRC-012",
          "type": "pk_unique",
          "model": "src__products",
          "columns": [
            "product_id"
          ]
        }
      ]
    },
    {
      "stage_id": 2,
      "tests": [
        {
          "test_id": "CAN-001",
          "type": "grain_assertion",
          "model": "int__session_entry_page",
          "expected_grain": "one row per website_session_id"
        },
        {
          "test_id": "CAN-002",
          "type": "grain_assertion",
          "model": "int__session_order_bridge",
          "expected_grain": "one row per website_session_id"
        },
        {
          "test_id": "CAN-003",
          "type": "grain_assertion",
          "model": "int__order_item_net_value",
          "expected_grain": "one row per order_item_id"
        },
        {
          "test_id": "CAN-004",
          "type": "expression_check",
          "model": "int__order_item_net_value",
          "rule": "net_revenue_usd = price_usd - coalesce(refund_amount_usd, 0)"
        },
        {
          "test_id": "CAN-005",
          "type": "no_orphans",
          "model": "stg__website_pageviews",
          "foreign_key": "website_session_id",
          "parent_model": "stg__website_sessions"
        },
        {
          "test_id": "CAN-006",
          "type": "no_orphans",
          "model": "stg__orders",
          "foreign_key": "website_session_id",
          "parent_model": "stg__website_sessions"
        },
        {
          "test_id": "CAN-007",
          "type": "no_orphans",
          "model": "stg__order_items",
          "foreign_key": "order_id",
          "parent_model": "stg__orders"
        },
        {
          "test_id": "CAN-008",
          "type": "no_orphans",
          "model": "stg__order_item_refunds",
          "foreign_key": "order_item_id",
          "parent_model": "stg__order_items"
        },
        {
          "test_id": "CAN-009",
          "type": "ref_required",
          "model_family": "stage_2_onward",
          "rule": "Use {{ ref('model_name') }} for internally generated upstream models."
        }
      ]
    },
    {
      "stage_id": 3,
      "tests": [
        {
          "test_id": "AQJ-001",
          "type": "grain_assertion",
          "model": "mart__landing_page_day",
          "expected_grain": "one row per session_date and entry_page"
        },
        {
          "test_id": "AQJ-002",
          "type": "range_check",
          "model": "diag__acquisition_leak",
          "column": "severity_score",
          "min_value": 0,
          "max_value": 100
        },
        {
          "test_id": "AQJ-003",
          "type": "range_check",
          "model": "diag__journey_leak",
          "column": "severity_score",
          "min_value": 0,
          "max_value": 100
        },
        {
          "test_id": "AQJ-004",
          "type": "comparison_window_rule",
          "model": "diag__experiment_findings",
          "rule": "Only compare variants during periods when both variants are active and exposed to comparable traffic conditions."
        },
        {
          "test_id": "AQJ-005",
          "type": "non_null",
          "model": "diag__experiment_findings",
          "columns": [
            "comparison_window_start",
            "comparison_window_end",
            "variant_key",
            "baseline_key"
          ]
        }
      ]
    },
    {
      "stage_id": 4,
      "tests": [
        {
          "test_id": "PBR-001",
          "type": "range_check",
          "model": "mart__bundle_attachment",
          "column": "bundle_attachment_rate",
          "min_value": 0,
          "max_value": 1
        },
        {
          "test_id": "PBR-002",
          "type": "range_check",
          "model": "mart__refund_rate_day",
          "column": "refund_value_share",
          "min_value": 0,
          "max_value": 1
        },
        {
          "test_id": "PBR-003",
          "type": "range_check",
          "model": "diag__basket_leak",
          "column": "severity_score",
          "min_value": 0,
          "max_value": 100
        },
        {
          "test_id": "PBR-004",
          "type": "range_check",
          "model": "diag__refund_leak",
          "column": "severity_score",
          "min_value": 0,
          "max_value": 100
        },
        {
          "test_id": "PBR-005",
          "type": "launch_window_rule",
          "model": "diag__launch_leak",
          "rule": "Launch windows must begin no earlier than dim__products.created_at for the relevant product."
        }
      ]
    },
    {
      "stage_id": 5,
      "tests": [
        {
          "test_id": "OBS-001",
          "type": "pk_unique",
          "model": "obs__leak_registry",
          "columns": [
            "period_start",
            "entity_type",
            "entity_key",
            "leak_type"
          ]
        },
        {
          "test_id": "OBS-002",
          "type": "range_check",
          "model": "obs__leak_registry",
          "column": "severity_score",
          "min_value": 0,
          "max_value": 100
        },
        {
          "test_id": "OBS-003",
          "type": "non_null",
          "model": "obs__priority_actions",
          "columns": [
            "priority_rank",
            "recommended_action",
            "expected_leak_reduction"
          ]
        },
        {
          "test_id": "OBS-004",
          "type": "traceability_rule",
          "model": "obs__leak_explainers",
          "rule": "Every explainer row must cite the supporting upstream model names used to justify the finding."
        }
      ]
    }
  ]
}
